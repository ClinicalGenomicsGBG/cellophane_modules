- id: slims_not_configured
  external:
    ../cellophane_modules/slims: modules/slims

  args:
    --workdir: work

  logs:
    - "_NOPE_"

- id: slims_fetch
  external:
    ../cellophane_modules/slims: modules/slims

  mocks:
    _cellophane_module_slims.Slims.fetch:
      kwargs:
        return_value:
        - !!python/object/apply:cellophane.data.Container
          kwds:
            cntn_fk_contentType: {value: 22}
            cntn_id: {value: 1337}
            cntn_fk_originalContent: {value: 1337}
            pk:
              !!python/object/apply:unittest.mock.MagicMock
              kwds:
                return_value: 1337


  args:
    --workdir: work
    --slims_username: "DUMMY"
    --slims_password: "DUMMY"
    --slims_url: 'DUMMY'
    --slims_find_criteria: "cntn_Dummy equals 1"
    --slims_check_criteria: "cntn_fk_contentType equals 22"

  logs:
    - "_NOPE_"

- &slims_augment
  id: slims_augment
  external:
    ../cellophane_modules/slims: modules/slims

  structure:
    samples.yaml: |
      - id: a
        meta:
          key: VALID
      - id: b
        meta:
          key: INVALID
    input:
      a: a
      b: b
  mocks:
    _cellophane_module_slims.Slims.fetch:
      kwargs:
        return_value:
        - !!python/object/apply:slims_.RecordMock
          kwds:
            cntn_fk_contentType: {value: 22}
            cntn_id: {value: a}
            cntn_cstm_Key: {value: VALID}
            cntn_cstm_Files: {value: ["input/a"]}

        - !!python/object/apply:slims_.RecordMock
          kwds:
            cntn_fk_contentType: {value: 22}
            cntn_id: {value: b}
            cntn_cstm_Key: {value: VALID}
            cntn_cstm_Files: {value: ["input/b"]}
  args:
    --workdir: work
    --samples_file: samples.yaml
    --slims_username: "DUMMY"
    --slims_password: "DUMMY"
    --slims_url: 'DUMMY'
    --slims_find_criteria: ""
    --slims_map: "files=cntn_cstm_Files,meta.key=cntn_cstm_Key"

- <<: *slims_augment
  id: slims_augment_multi_match
  structure:
    samples.yaml: |
      - id: a
    input:
      a_1: a
      a_2: a
  mocks:
    _cellophane_module_slims.Slims.fetch:
      kwargs:
        return_value:
        - !!python/object/apply:slims_.RecordMock
          kwds:
            cntn_fk_contentType: {value: 22}
            cntn_id: {value: a}
            cntn_cstm_Files: {value: ["input/a_1"]}

        - !!python/object/apply:slims_.RecordMock
          kwds:
            cntn_fk_contentType: {value: 22}
            cntn_id: {value: a}
            cntn_cstm_Files: {value: ["input/a_2"]}

  logs:
    - "_NOPE_"

- id: slims_derive
  external:
    ../cellophane_modules/slims: modules/slims

  structure:
    modules:
      dummy.py: |
        from cellophane import modules

        @modules.runner
        def dummy(samples, **kwargs):
          for sample in samples:
            if sample.id == "fail":
              sample.fail("DUMMY")

    samples.yaml: |
      - id: pass
        files:
        - input/pass
      - id: fail
        files:
        - input/fail
    
    input:
      pass: pass
      fail: fail

  mocks:
    _cellophane_module_slims.Slims.add: ~
    _cellophane_module_slims.Record.update: ~
    _cellophane_module_slims.Slims.fetch:
      kwargs:
        return_value:
        - !!python/object/apply:slims_.RecordMock
          kwds:
            cntn_fk_contentType: {value: 22}
            cntn_id: {value: a}
            # pk:
            #   !!python/object/apply:unittest.mock.MagicMock
            #   kwds:
            #     return_value: 1337
            # slims_api: !!python/object/apply:unittest.mock.MagicMock
            #   args: ~
  args:
    --workdir: work
    --samples_file: samples.yaml
    --slims_username: "DUMMY"
    --slims_password: "DUMMY"
    --slims_url: 'DUMMY'
    --slims_find_criteria: ""
    --slims_derive: !!python/tuple
      - cntn_fk_contentType=23,
        cntn_fk_location=83,
        cntn_cstm_SecondaryAnalysisState={sample.state},
        cntn_status=10
  
  logs:
    - "_NOPE_"

- id: slims_no_records
  external:
    ../cellophane_modules/slims: modules/slims

  mocks:
    _cellophane_module_slims.Slims.fetch:
      kwargs:
        return_value: []
  args:
    --workdir: work
    --slims_username: "DUMMY"
    --slims_password: "DUMMY"
    --slims_url: 'DUMMY'
    --slims_find_criteria: ""
  
  logs:
    - "_NOPE_"


- id: slims_by_id
  external:
    ../cellophane_modules/slims: modules/slims

  mocks:
    _cellophane_module_slims.Slims.fetch:
      kwargs:
        return_value:
        - !!python/object/apply:slims_.RecordMock
          kwds:
            cntn_fk_contentType: {value: 22}
            cntn_id: {value: a}
            pk:
              !!python/object/apply:unittest.mock.MagicMock
              kwds:
                return_value: 1337
            slims_api: !!python/object/apply:unittest.mock.MagicMock
              args: ~
  args:
    --workdir: work
    --slims_username: "DUMMY"
    --slims_password: "DUMMY"
    --slims_url: 'DUMMY'
    --slims_find_criteria: ""
    --slims_id: a
  
  logs:
    - "_NOPE_"

- id: slims_update_dry_run
  external:
    ../cellophane_modules/slims: modules/slims
  structure:
    samples.yaml: |
      - id: a
        files:
        - input/a
    input:
      a: a
  mocks:
    _cellophane_module_slims.Slims.fetch:
      kwargs:
        return_value:
        - !!python/object/apply:slims_.RecordMock
          kwds:
            cntn_id: {value: a}
  args:
    --workdir: work
    --samples_file: samples.yaml
    --slims_username: "DUMMY"
    --slims_password: "DUMMY"
    --slims_url: 'DUMMY'
    --slims_find_criteria: "cntn_Dummy equals 1"
    --slims_dry_run: ~
    --slims_derive: !!python/tuple
      - cntn_fk_contentType=23,
        cntn_fk_location=83,
        cntn_cstm_SecondaryAnalysisState={sample.state},
        cntn_status=10
  
  logs:
    - "_NOPE_"
